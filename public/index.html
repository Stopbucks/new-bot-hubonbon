<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Info Commander Console</title>
    <style>
        :root { --bg: #1e1e1e; --panel: #252526; --text: #d4d4d4; --accent: #0e639c; --border: #3c3c3c; --hover: #2a2d2e; }
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }
        
        /* å·¦å´ï¼šRSS åˆ—è¡¨ */
        #sidebar { width: 350px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .sidebar-header { padding: 10px 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #333333; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 5px; }
        
        .rss-item { padding: 12px; border-bottom: 1px solid #333; cursor: pointer; transition: 0.2s; font-size: 14px; line-height: 1.4; border-radius: 4px; }
        .rss-item:hover { background: var(--hover); border-left: 3px solid var(--accent); }
        .rss-source { font-weight: bold; color: #4fc1ff; margin-bottom: 4px; display: block; font-size: 12px; }
        .rss-date { font-size: 11px; color: #666; display: block; margin-top: 4px; }

        /* å³å´ï¼šå·¥ä½œå€ */
        #main { flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 15px; background: var(--bg); }
        h2 { margin: 0; font-size: 18px; color: #fff; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        
        /* æ§åˆ¶é … */
        .controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        button { background: var(--accent); color: white; border: none; padding: 8px 16px; cursor: pointer; border-radius: 3px; font-size: 13px; transition: 0.2s; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        button:active { transform: translateY(0); }
        button.secondary { background: #3c3c3c; }
        button.publish-finance { background: #2da042; } /* Github Green */
        button.publish-sports { background: #ce9178; }  /* VSCode Orange */
        
        /* ç·¨è¼¯å€ */
        .editor-container { flex: 1; display: flex; flex-direction: column; position: relative; }
        textarea { flex: 1; background: #1e1e1e; border: 1px solid var(--border); color: #d4d4d4; padding: 15px; font-family: Consolas, 'Courier New', monospace; font-size: 15px; resize: none; outline: none; line-height: 1.6; border-radius: 4px; }
        textarea:focus { border-color: var(--accent); }

        /* ç‹€æ…‹åˆ— */
        #status { font-size: 12px; color: #888; margin-top: 5px; height: 20px; display: flex; align-items: center; }
        .status-loading { color: #dcdcaa; }
        .status-success { color: #6a9955; }
        .status-error { color: #f48771; }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="sidebar-header">
            <span style="font-weight:bold; color: #fff;">ğŸ“¡ RSS Monitor</span>
            <button class="secondary" onclick="loadRSS()" style="padding:4px 10px; font-size:12px;">Refresh</button>
        </div>
        <div id="rss-list" class="sidebar-content">
            <div style="padding:20px; text-align:center; color:#666;">é»æ“Š Refresh è¼‰å…¥æ–°è</div>
        </div>
    </div>

    <div id="main">
        <div>
            <h2>ğŸ“ Gate Draft Room</h2>
            <div class="controls" style="margin-top: 15px;">
                <button class="secondary" onclick="analyzeUrl()">ğŸ” åˆ†æç¶²å€ (AI)</button>
                <button class="secondary" onclick="generateDraft()">âœ¨ ç”Ÿæˆè²¼æ–‡ (AI)</button>
                <span style="flex:1"></span>
                <button class="publish-finance" onclick="publish('post_finance')">ğŸ’° ç™¼å¸ƒè²¡ç¶“</button>
                <button class="publish-sports" onclick="publish('post_sports')">ğŸ€ ç™¼å¸ƒé«”è‚²</button>
            </div>
        </div>
        
        <div class="editor-container">
            <textarea id="editor" placeholder="åœ¨æ­¤è²¼ä¸Šç¶²å€ï¼Œæˆ–ç›´æ¥é–‹å§‹æ’°å¯«...&#10;è‹¥é»æ“Šå·¦å´æ–°èï¼Œç¶²å€æœƒè‡ªå‹•å¸¶å…¥ã€‚"></textarea>
        </div>
        <div id="status">System Ready.</div>
    </div>

    <script>
        const editor = document.getElementById('editor');
        const status = document.getElementById('status');
        const rssList = document.getElementById('rss-list');

        function log(msg, type='') { 
            status.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`; 
            status.className = type ? `status-${type}` : '';
        }

        // 1. è¼‰å…¥ RSS
        async function loadRSS() {
            log('æ­£åœ¨è¼ªè©¢ RSS ä¾†æº...', 'loading');
            rssList.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">è¼‰å…¥ä¸­...</div>';
            try {
                const res = await fetch('/api/rss', { method: 'POST' });
                const items = await res.json();
                
                rssList.innerHTML = '';
                if(items.length === 0) {
                    rssList.innerHTML = '<div style="padding:20px; text-align:center;">ç„¡è³‡æ–™</div>';
                    return;
                }

                items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'rss-item';
                    const dateStr = item.pubDate ? new Date(item.pubDate).toLocaleString('zh-TW', {month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'}) : '';
                    
                    div.innerHTML = `
                        <span class="rss-source">${item.title.split(']')[0]}]</span>
                        <span>${item.title.split(']').slice(1).join(']')}</span>
                        <span class="rss-date">${dateStr}</span>
                    `;
                    div.onclick = () => {
                        editor.value = item.link;
                        log(`å·²é¸å–: ${item.title.substring(0, 20)}...`);
                    };
                    rssList.appendChild(div);
                });
                log(`RSS æ›´æ–°å®Œæˆï¼Œå…± ${items.length} å‰‡å¿«è¨Š`, 'success');
            } catch (e) { log('RSS è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Server Log', 'error'); }
        }

        // 2. åˆ†æç¶²å€
        async function analyzeUrl() {
            const url = editor.value.trim();
            if(!url.startsWith('http')) return alert('è«‹å…ˆè²¼ä¸Šæœ‰æ•ˆç¶²å€');
            log('AI æ­£åœ¨é–±è®€ç¶²é ä¸¦é€²è¡Œæ‘˜è¦...', 'loading');
            try {
                const res = await fetch('/api/summarize', { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ url })
                });
                const data = await res.json();
                editor.value = data.summary;
                log('æ‘˜è¦å®Œæˆï¼Œè«‹æª¢è¦–å…§å®¹', 'success');
            } catch (e) { log('åˆ†æå¤±æ•—', 'error'); }
        }

        // 3. ç”Ÿæˆè‰ç¨¿
        async function generateDraft() {
            const text = editor.value;
            if(!text) return alert('ç·¨è¼¯å€ç„¡å…§å®¹');
            log('AI æ­£åœ¨æ”¹å¯«ç‚º FB é¢¨æ ¼ (Gate)...', 'loading');
            try {
                const res = await fetch('/api/gate-draft', { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ text })
                });
                const data = await res.json();
                editor.value = `${data.content}\n\nğŸ–¼ï¸ IMAGE_SRC: ${data.imageUrl}`;
                log('è‰ç¨¿ç”Ÿæˆå®Œç•¢', 'success');
            } catch (e) { log('ç”Ÿæˆå¤±æ•—', 'error'); }
        }

        // 4. ç™¼å¸ƒ
        async function publish(target) {
            const raw = editor.value;
            if(!raw) return;
            if(!confirm(`ç¢ºèªè¦ç™¼å¸ƒåˆ° [${target}] ?`)) return;
            
            let content = raw;
            let imageUrl = '';
            const match = raw.match(/ğŸ–¼ï¸ IMAGE_SRC: (.*)/);
            if (match) { imageUrl = match[1]; content = raw.replace(match[0], '').trim(); }

            log('æ­£åœ¨å‚³é€è‡³ Make...', 'loading');
            try {
                await fetch('/api/publish', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ target, content, imageUrl, timestamp: new Date().toISOString() })
                });
                log('ğŸš€ å·²æˆåŠŸç™¼å°„è¨Šè™Ÿ!', 'success');
                editor.value = ''; // æ¸…ç©º
            } catch (e) { log('ç™¼é€å¤±æ•—', 'error'); }
        }
        
        // å•Ÿå‹•æ™‚è‡ªå‹•è¼‰å…¥
        loadRSS();
    </script>
</body>
</html>